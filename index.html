<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø«Ø¨Øª Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ø´ØªØ±ÛŒ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #6276a3;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: #333;
        }
        
        .container {
            width: 100%;
            max-width: 500px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            position: relative;
        }
        
        .header {
            background: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .logo {
            height: 50px;
        }
        
        .header h1 {
            color: #6276a3;
            font-size: 22px;
            font-weight: 700;
        }
        
        .content {
            padding: 30px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #6276a3;
            font-size: 18px;
        }
        
        .form-control {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 18px;
            transition: border-color 0.3s;
            text-align: center;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #6276a3;
        }
        
        .btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #6276a3, #4a5d8a);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        .btn:hover {
            background: linear-gradient(135deg, #4a5d8a, #37496f);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(98, 118, 163, 0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .status-box {
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            font-weight: 500;
            text-align: center;
            display: none;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border-right: 5px solid #28a745;
        }
        
        .status-warning {
            background: #fff3cd;
            color: #856404;
            border-right: 5px solid #ffc107;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border-right: 5px solid #dc3545;
        }
        
        .status-info {
            background: #e7f3ff;
            color: #0066cc;
            border-right: 5px solid #2D8CFF;
        }
        
        .result-box {
            margin-top: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 15px;
            border: 2px solid #6276a3;
            display: none;
        }
        
        .result-header {
            text-align: center;
            margin-bottom: 20px;
            color: #6276a3;
            font-size: 20px;
            font-weight: 700;
        }
        
        .separator {
            height: 2px;
            background: #6276a3;
            margin: 20px 0;
            opacity: 0.3;
        }
        
        .result-line {
            margin: 15px 0;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .result-label {
            font-weight: 600;
            color: #6276a3;
            display: inline-block;
            width: 120px;
        }
        
        .copy-btn {
            background: linear-gradient(135deg, #28a745, #1e7e34);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            transition: all 0.3s;
        }
        
        .copy-btn:hover {
            background: linear-gradient(135deg, #1e7e34, #155724);
            transform: translateY(-2px);
        }
        
        .copy-btn:active {
            transform: translateY(0);
        }
        
        .timer {
            text-align: center;
            font-size: 36px;
            font-weight: 700;
            color: #6276a3;
            margin: 20px 0;
            font-family: monospace;
            display: none;
        }
        
        .accuracy-meter {
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            margin: 15px 0;
            overflow: hidden;
        }
        
        .accuracy-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff4444, #ffbb33, #00C851);
            width: 0%;
            transition: width 0.5s;
        }
        
        .accuracy-label {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .instructions {
            background: #f0f7ff;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-size: 14px;
            color: #555;
            border-right: 4px solid #6276a3;
        }
        
        @media (max-width: 600px) {
            .content {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 18px;
            }
            
            .form-control, .btn {
                padding: 15px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Ø«Ø¨Øª Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ú©Ø§Ù†ÛŒ</h1>
            <img src="https://kalleh.com/wp-content/themes/kalleh/assets/images/logo-fa.png" alt="Logo" class="logo">
        </div>
        
        <div class="content">
            <div class="form-group">
                <label for="customerCode">Ú©Ø¯ Ù…Ø´ØªØ±ÛŒ</label>
                <input type="number" id="customerCode" class="form-control" placeholder="Ù…Ø«Ø§Ù„: 123456" min="1">
            </div>
            
            <div class="instructions">
                <strong>ğŸ“± Ù†Ú©Ø§Øª Ù…Ù‡Ù…:</strong>
                <ul style="margin-top: 10px; padding-right: 20px;">
                    <li>Ø¨Ø±Ø§ÛŒ Ø¯Ù‚Øª Ø¨Ù‡ØªØ±ØŒ Ø¯Ø± ÙØ¶Ø§ÛŒ Ø¨Ø§Ø² Ø¨Ø§Ø´ÛŒØ¯</li>
                    <li>GPS Ú¯ÙˆØ´ÛŒ Ø±Ø§ Ø±ÙˆØ´Ù† Ú©Ù†ÛŒØ¯</li>
                    <li>Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª ÙØ¹Ø§Ù„ Ø¨Ø§Ø´Ø¯</li>
                    <li>Ø­Ø¯Ø§Ú©Ø«Ø± Ø²Ù…Ø§Ù†: 60 Ø«Ø§Ù†ÛŒÙ‡</li>
                </ul>
            </div>
            
            <div class="timer" id="timer">60</div>
            
            <div class="accuracy-meter">
                <div class="accuracy-fill" id="accuracyFill"></div>
            </div>
            <div class="accuracy-label">
                <span>Ø¯Ù‚Øª Ú©Ù…</span>
                <span>Ø¯Ù‚Øª Ø®ÙˆØ¨</span>
                <span>Ø¹Ø§Ù„ÛŒ</span>
            </div>
            
            <button class="btn" id="locationBtn" onclick="getLocation()">
                Ø«Ø¨Øª Ù…ÙˆÙ‚Ø¹ÛŒØª
            </button>
            
            <div id="status" class="status-box"></div>
            
            <div class="result-box" id="resultBox">
                <div class="result-header">ğŸ“ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ú©Ø§Ù†ÛŒ</div>
                
                <div class="separator"></div>
                
                <div class="result-line">
                    <span class="result-label">SAPCODE:</span>
                    <span id="resultSapCode"></span>
                </div>
                
                <div class="separator"></div>
                
                <div class="result-line">
                    <span class="result-label">latitude:</span>
                    <span id="resultLat"></span>
                </div>
                
                <div class="result-line">
                    <span class="result-label">longitude:</span>
                    <span id="resultLon"></span>
                </div>
                
                <div class="separator"></div>
                
                <div class="result-line">
                    <span class="result-label">google map:</span>
                    <a id="mapLink" target="_blank" style="color: #0066cc; text-decoration: none;">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡</a>
                </div>
                
                <textarea id="copyText" style="display: none;"></textarea>
                
                <button class="copy-btn" onclick="copyToClipboard()">ğŸ“‹ Ú©Ù¾ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª</button>
            </div>
        </div>
    </div>

    <script>
    // Global variables
    let timerInterval = null;
    let timeLeft = 60;
    let isGettingLocation = false;
    let watchId = null;
    
    // Get location function
    function getLocation() {
        // Validate customer code
        const customerCode = document.getElementById('customerCode').value;
        if (!customerCode || customerCode.trim() === '') {
            showStatus('Ù„Ø·ÙØ§Ù‹ Ú©Ø¯ Ù…Ø´ØªØ±ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error');
            return;
        }
        
        if (isGettingLocation) return;
        
        isGettingLocation = true;
        timeLeft = 60;
        
        // Update UI
        const btn = document.getElementById('locationBtn');
        btn.innerHTML = '<span class="loading"></span> Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ù…ÙˆÙ‚Ø¹ÛŒØª...';
        btn.disabled = true;
        
        // Show timer
        const timerElement = document.getElementById('timer');
        timerElement.style.display = 'block';
        timerElement.textContent = timeLeft;
        
        // Hide previous results
        document.getElementById('resultBox').style.display = 'none';
        
        // Start timer
        startTimer();
        
        // Show initial status
        showStatus('Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ù‚Ø±Ø§Ø±ÛŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ GPS...', 'info');
        
        // Start GPS with high accuracy
        const options = {
            enableHighAccuracy: true,  // Force GPS for better accuracy
            timeout: 55000,            // 55 seconds timeout (less than 1 min)
            maximumAge: 0              // No cached positions
        };
        
        // Use watchPosition to get multiple readings and better accuracy
        watchId = navigator.geolocation.watchPosition(
            // Success callback
            (position) => {
                const accuracy = position.coords.accuracy;
                
                // Update accuracy meter (0-100%)
                let accuracyPercent = 0;
                if (accuracy <= 5) accuracyPercent = 100;
                else if (accuracy <= 10) accuracyPercent = 90;
                else if (accuracy <= 20) accuracyPercent = 70;
                else if (accuracy <= 50) accuracyPercent = 40;
                else if (accuracy <= 100) accuracyPercent = 20;
                
                document.getElementById('accuracyFill').style.width = accuracyPercent + '%';
                
                // Check if accuracy is good enough (<10m)
                if (accuracy <= 10) {
                    // We got good accuracy! Stop and show results
                    navigator.geolocation.clearWatch(watchId);
                    finishWithSuccess(position, customerCode);
                    return;
                } else {
                    // Still working on better accuracy
                    showStatus(`Ø¯Ù‚Øª ÙØ¹Ù„ÛŒ: ${Math.round(accuracy)} Ù…ØªØ± - Ø¯Ø± Ø­Ø§Ù„ Ø¨Ù‡Ø¨ÙˆØ¯...`, 'warning');
                }
            },
            // Error callback
            (error) => {
                handleLocationError(error);
            },
            options
        );
        
        // Fallback: If we don't get <10m accuracy in time, use the best we got
        setTimeout(() => {
            if (isGettingLocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        finishWithSuccess(position, customerCode);
                    },
                    (error) => {
                        handleLocationError(error);
                    },
                    { enableHighAccuracy: false, timeout: 5000 }
                );
            }
        }, 58000); // 58 seconds
    }
    
    // Start countdown timer
    function startTimer() {
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            timeLeft--;
            document.getElementById('timer').textContent = timeLeft;
            
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                if (isGettingLocation) {
                    showStatus('Ø²Ù…Ø§Ù† Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯', 'error');
                    resetUI();
                }
            }
        }, 1000);
    }
    
    // Finish with success
    function finishWithSuccess(position, customerCode) {
        clearInterval(timerInterval);
        
        const accuracy = position.coords.accuracy;
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;
        const mapUrl = `https://maps.google.com/?q=${lat},${lon}`;
        
        // Update UI
        const btn = document.getElementById('locationBtn');
        btn.innerHTML = 'Ø«Ø¨Øª Ù…ÙˆÙ‚Ø¹ÛŒØª';
        btn.disabled = false;
        
        // Hide timer
        document.getElementById('timer').style.display = 'none';
        
        // Show status based on accuracy
        if (accuracy <= 10) {
            showStatus(`âœ… Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¨Ø§ Ø¯Ù‚Øª ${Math.round(accuracy)} Ù…ØªØ± Ø«Ø¨Øª Ø´Ø¯`, 'success');
        } else {
            showStatus(`âš ï¸ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¨Ø§ Ø¯Ù‚Øª ${Math.round(accuracy)} Ù…ØªØ± Ø«Ø¨Øª Ø´Ø¯ (Ø¯Ù‚Øª Ú©Ù…ØªØ± Ø§Ø² Ø­Ø¯ Ù…Ø·Ù„ÙˆØ¨)`, 'warning');
        }
        
        // Set results
        document.getElementById('resultSapCode').textContent = customerCode;
        document.getElementById('resultLat').textContent = lat.toFixed(6);
        document.getElementById('resultLon').textContent = lon.toFixed(6);
        document.getElementById('mapLink').href = mapUrl;
        
        // Prepare text for copying
        const copyText = `------------------------------
SAPCODE: ${customerCode}
------------------------------
latitude: ${lat.toFixed(6)}
longitude: ${lon.toFixed(6)}
------------------------------
google map link: ${mapUrl}`;
        
        document.getElementById('copyText').value = copyText;
        
        // Show result box
        document.getElementById('resultBox').style.display = 'block';
        
        // Scroll to results
        document.getElementById('resultBox').scrollIntoView({ behavior: 'smooth' });
        
        isGettingLocation = false;
    }
    
    // Handle location errors
    function handleLocationError(error) {
        clearInterval(timerInterval);
        
        let errorMessage = 'Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù…ÙˆÙ‚Ø¹ÛŒØª: ';
        switch(error.code) {
            case error.PERMISSION_DENIED:
                errorMessage = 'Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ú©Ø§Ù†ÛŒ Ø±Ø¯ Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¯Ø± ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ø±ÙˆØ±Ú¯Ø± Ø§Ø¬Ø§Ø²Ù‡ Ø¯Ù‡ÛŒØ¯.';
                break;
            case error.POSITION_UNAVAILABLE:
                errorMessage = 'Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª. Ù„Ø·ÙØ§Ù‹ GPS Ø±Ø§ Ø±ÙˆØ´Ù† Ú©Ù†ÛŒØ¯.';
                break;
            case error.TIMEOUT:
                errorMessage = 'Ø¯Ø±ÛŒØ§ÙØª Ù…ÙˆÙ‚Ø¹ÛŒØª Ø²Ù…Ø§Ù†â€ŒØ¨Ø± Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.';
                break;
            default:
                errorMessage = 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù…ÙˆÙ‚Ø¹ÛŒØª.';
        }
        
        showStatus(errorMessage, 'error');
        resetUI();
    }
    
    // Reset UI
    function resetUI() {
        isGettingLocation = false;
        
        const btn = document.getElementById('locationBtn');
        btn.innerHTML = 'Ø«Ø¨Øª Ù…ÙˆÙ‚Ø¹ÛŒØª';
        btn.disabled = false;
        
        document.getElementById('timer').style.display = 'none';
        document.getElementById('accuracyFill').style.width = '0%';
    }
    
    // Show status messages
    function showStatus(message, type) {
        const statusDiv = document.getElementById('status');
        statusDiv.innerHTML = message;
        statusDiv.className = `status-box status-${type}`;
        statusDiv.style.display = 'block';
        
        // Auto-hide success messages after 5 seconds
        if (type === 'success') {
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }
    }
    
    // Copy to clipboard
    function copyToClipboard() {
        const textarea = document.getElementById('copyText');
        textarea.style.display = 'block';
        textarea.select();
        textarea.setSelectionRange(0, 99999);
        
        try {
            const successful = document.execCommand('copy');
            if (successful) {
                showStatus('âœ… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ú©Ù¾ÛŒ Ø´Ø¯', 'success');
                
                // Change button text temporarily
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = 'âœ… Ú©Ù¾ÛŒ Ø´Ø¯!';
                btn.style.background = 'linear-gradient(135deg, #28a745, #1e7e34)';
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = 'linear-gradient(135deg, #28a745, #1e7e34)';
                }, 2000);
            }
        } catch (err) {
            showStatus('âŒ Ø®Ø·Ø§ Ø¯Ø± Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù† Ø§Ø·Ù„Ø§Ø¹Ø§Øª', 'error');
        }
        
        textarea.style.display = 'none';
    }
    
    // Initialize
    window.addEventListener('load', () => {
        // Check if geolocation is supported
        if (!navigator.geolocation) {
            showStatus('Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² Ù‚Ø§Ø¨Ù„ÛŒØª Ù…ÙˆÙ‚Ø¹ÛŒØªâ€ŒÛŒØ§Ø¨ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯', 'error');
            document.getElementById('locationBtn').disabled = true;
        }
        
        // Focus on customer code field
        document.getElementById('customerCode').focus();
        
        // Allow Enter key to trigger location
        document.getElementById('customerCode').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                getLocation();
            }
        });
    });
    </script>
</body>
</html>
